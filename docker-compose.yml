services:
 postgres:
  image: postgres:16-alpine
  container_name: webstudio-postgres
  environment:
   - POSTGRES_USER=webstudio
   - POSTGRES_PASSWORD=rugjaf-zacbo4-fyRpak
   - POSTGRES_DB=webstudio
  volumes:
   - postgres_data:/var/lib/postgresql/data
  ports:
   - "5432:5432"
  restart: always
  healthcheck:
   test: ["CMD-SHELL", "pg_isready -U webstudio -d webstudio"]
   interval: 10s
   timeout: 5s
   retries: 5

 webstudio:
  build: .
  container_name: webstudio-builder
  environment:
    - NODE_ENV=production
    - HOST=0.0.0.0
    - PORT=3000
    - DATABASE_URL=postgresql://webstudio:rugjaf-zacbo4-fyRpak@postgres:5432/webstudio

    # Base URLs
    - PUBLIC_URL=https://builder.sociarena.com
    - APP_URL=https://builder.sociarena.com
    - BASE_URL=https://builder.sociarena.com

    # Session secrets (generate with: openssl rand -base64 32)
    - SESSION_SECRET=cYNMvnFYNvHH6l4r18l+8dtuyghWbG9hCA/Q3BuAwoU=
    - COOKIE_SECRET=0SDri/F28b8R0ud3eOfzlg9/OpIroWjey98ytac9y7Q=
    - ENCRYPTION_SECRET=cYNMvnFYNvHH6l4r18l+8dtuyghWbG9hCA/Q3BuAwoU=

    # OIDC Configuration
    - OIDC_ISSUER=https://login.infomaniak.com
    - OIDC_CLIENT_ID=e97a8676-fc42-471f-8506-111f526f96ed
    - OIDC_CLIENT_SECRET=vwxhJkGe2tXh5DqAri88I4xmnfTa2lGem3dzvECanDAA72Nz64i0YuGZB7y2QQsb
    - OIDC_REDIRECT_URI=https://builder.sociarena.com/auth/infomaniak/callback
    - OIDC_SCOPES=openid profile email

    # CORS and Security
    - ALLOWED_ORIGINS=https://builder.sociarena.com
    - TRUST_PROXY=true
    
      # PostgREST configuration
    - POSTGREST_URL=http://postgrest:3000
    - POSTGREST_API_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImttZHBpeHpvcWlpcmJtcGRpcHB5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE2NjYzMz
      Y0MjgsImV4cCI6MTk4MTkxMjQyOH0.jjeYvTDrWP9pV7dfZr6fptualNQ3aR13kuPhvT25Sso
  ports:
   - "3000:3000"
  expose:
   - "3000"
  depends_on:
   postgres:
    condition: service_healthy
  restart: always

 postgrest:
  image: postgrest/postgrest:v12.2.0
  container_name: webstudio-postgrest
  depends_on:
    postgres:
      condition: service_healthy
  restart: always
  environment:
    PGRST_DB_URI: postgresql://webstudio:rugjaf-zacbo4-fyRpak@postgres:5432/webstudio
    PGRST_DB_SCHEMAS: public
    PGRST_DB_ANON_ROLE: webstudio
    PGRST_JWT_SECRET: jwtsecretjwtsecretjwtsecretjwtsecretjwtsecretjwtsecretjwtsecretjwtsecretjwtsecretjwtsecretjwtsecretjwtsecret
    PGRST_DB_USE_LEGACY_GUCS: "false"
    PGRST_APP_SETTINGS_JWT_SECRET: jwtsecretjwtsecretjwtsecretjwtsecretjwtsecretjwtsecretjwtsecretjwtsecretjwtsecretjwtsecretjwtsecretjwtsecret
  ports:
    - "3001:3000"

volumes:
 postgres_data:
